<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Điều khiển biến tần — Web HMI (MQTT)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6fb; margin:0; }
    .card { max-width: 900px; margin: 20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
    h1 { margin-top:0; }
    .row { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    input, button { padding:8px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; font-weight:bold; }
    .btn-start{ background:#0b84ff; color:white; border:none; }
    .btn-rev{ background:#ff6b6b; color:white; border:none; }
    .btn-stop{ background:#666; color:white; border:none; }
    .telemetry{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px; }
    .tele-item{ background:#f9fafc; padding:10px; border-radius:8px; }
    .label{ font-size:12px; color:#666; }
    .value{ font-size:20px; font-weight:bold; }
    #log { background:#111; color:#0f0; font-family:monospace; padding:10px; border-radius:6px; height:150px; overflow:auto; margin-top:12px; white-space:pre-wrap; }
    #connStatus { display:flex; align-items:center; gap:6px; font-weight:bold; margin-bottom:12px; }
    #connDot { width:12px; height:12px; border-radius:50%; background:red; display:inline-block; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Điều khiển biến tần — MQTT</h1>

    <!-- Trạng thái kết nối -->
    <div id="connStatus">
      <span id="connDot"></span>
      <span id="connText">Đang ngắt</span>
    </div>

    <!-- Điều khiển -->
    <div class="row">
      <label>Tần số (Hz):</label>
      <input id="freqIn" type="number" value="50" min="0" max="400" step="0.1">
      <button class="btn-start" id="btnStart">Chạy thuận ▶</button>
      <button class="btn-rev" id="btnRev">Chạy nghịch ◀</button>
      <button class="btn-stop" id="btnStop">Dừng ■</button>
    </div>

    <!-- Telemetry -->
    <div class="telemetry">
      <div class="tele-item">
        <div class="label">Tần số output</div>
        <div id="freqOut" class="value">—</div>
      </div>
      <div class="tele-item">
        <div class="label">Điện áp</div>
        <div id="voltage" class="value">—</div>
      </div>
      <div class="tele-item">
        <div class="label">Dòng</div>
        <div id="current" class="value">—</div>
      </div>
      <div class="tele-item">
        <div class="label">Trạng thái</div>
        <div id="state" class="value">—</div>
      </div>
    </div>

    <div id="fault" style="margin-top:10px;color:red;font-weight:bold;">Không có lỗi</div>
    <div id="log"></div>
  </div>

<script>
  // ==== Cấu hình MQTT ====
  const brokerUrl = "wss://test.mosquitto.org:8081/mqtt";
  const options = {
      clean: true,
      reconnectPeriod: 2000,
    };

  const topicCmd = "inverter/cmd";       // publish lệnh
  const topicStatus = "inverter/status"; // subscribe trạng thái

  // DOM
  const logEl = document.getElementById("log");
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const freqInEl = document.getElementById("freqIn");
  const btnStart = document.getElementById("btnStart");
  const btnRev   = document.getElementById("btnRev");
  const btnStop  = document.getElementById("btnStop");

  let isConnected = false;
  const originalLabels = {
    start: btnStart.textContent,
    rev: btnRev.textContent,
    stop: btnStop.textContent,
  };

  function log(msg){
    const now = new Date().toLocaleTimeString();
    logEl.textContent += `[${now}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setConn(status, color){
    connDot.style.background = color;
    connText.textContent = status;
  }

  function toggleControls(enable){
    if(enable){
      btnStart.disabled = false;
      btnRev.disabled   = false;
      btnStop.disabled  = false;
      freqInEl.disabled = false;

      btnStart.textContent = originalLabels.start;
      btnRev.textContent   = originalLabels.rev;
      btnStop.textContent  = originalLabels.stop;
    } else {
      btnStart.disabled = true;
      btnRev.disabled   = true;
      btnStop.disabled  = true;
      freqInEl.disabled = true;

      btnStart.textContent = "Chưa kết nối";
      btnRev.textContent   = "Chưa kết nối";
      btnStop.textContent  = "Chưa kết nối";
    }
  }

  // ==== Kết nối MQTT ====
  const client = mqtt.connect(brokerUrl, options);

  client.on("connect", () => {
    isConnected = true;
    setConn("Đã kết nối", "green");
    log("MQTT Connected");
    toggleControls(true);
    client.subscribe(topicStatus, { qos: 1 }, err => {
      if(!err) log("Subscribed: " + topicStatus);
    });
  });

  client.on("reconnect", () => {
    isConnected = false;
    setConn("Đang reconnect...", "orange");
    log("MQTT Reconnecting...");
    toggleControls(false);
  });

  client.on("error", err => {
    isConnected = false;
    setConn("Lỗi kết nối", "red");
    log("MQTT Error: " + err.message);
    toggleControls(false);
  });

  client.on("close", () => {
    isConnected = false;
    setConn("Đã ngắt", "red");
    log("MQTT Disconnected");
    toggleControls(false);
  });

  // ==== Nhận telemetry (chỉ dạng { "d": {...} }) ====
  client.on("message", (topic, payload) => {
    log("RX " + topic + ": " + payload);
    try {
      const j = JSON.parse(payload.toString());

      if (j.d) {
        // Tần số output: chia 100 để hiển thị Hz
        if (j.d.Output_frequency !== undefined) {
          const rawFreq = parseFloat(j.d.Output_frequency);
          if (!isNaN(rawFreq)) {
            document.getElementById("freqOut").textContent = (rawFreq / 100).toFixed(2) + " Hz";
          }
        }

        if (j.d["{VFD_M}1@W48452"] !== undefined) {
          document.getElementById("voltage").textContent = j.d["{VFD_M}1@W48452"];
        }
        if (j.d["{VFD_M}1@W48454"] !== undefined) {
          document.getElementById("current").textContent = j.d["{VFD_M}1@W48454"];
        }
        if (j.d.type) {
          document.getElementById("state").textContent = j.d.type;
        }
      }
    } catch (e) {
      log("⚠️ JSON parse error: " + e.message);
    }
  });

  // ==== Hàm gửi lệnh ====
  function sendCmd(obj, retain = false){
    if(!isConnected){
      log("⚠️ Chưa kết nối → không gửi");
      return;
    }
    const msg = JSON.stringify(obj);
    client.publish(topicCmd, msg, { qos: 1, retain: retain });
    log("TX " + msg + (retain ? " (retained)" : ""));
  }

  // Nút chạy thuận/nghịch/dừng
  btnStart.onclick = () => sendCmd({ d:{ Run_forward:"18", type:"UINT16", "{VFD_M}1@W48193":"18" } }, false);
  btnRev.onclick   = () => sendCmd({ d:{ Run_forward:"34", type:"UINT16", "{VFD_M}1@W48193":"34" } }, false);
  btnStop.onclick  = () => sendCmd({ d:{ Run_forward:"1",  type:"UINT16", "{VFD_M}1@W48193":"1"  } }, false);

  // Gửi tần số liên tục (500ms) với retain — theo cấu trúc yêu cầu
  setInterval(() => {
    if(!isConnected) return;
    const f = parseFloat(freqInEl.value);
    if(!isNaN(f)){
      const freqVal = Math.round(f * 100); // ví dụ: 50Hz → 5000
      const msgObj = {
        d: {
          Frequency_command: String(freqVal),
          type: "UINT16",
          "{VFD_M}1@W48194": String(freqVal)
        }
      };
      client.publish(topicCmd, JSON.stringify(msgObj), { qos:1, retain:true });
      log("TX set_freq: " + JSON.stringify(msgObj));
    }
  }, 500);

  // Ban đầu disable nút
  toggleControls(false);
</script>
</body>
</html>
