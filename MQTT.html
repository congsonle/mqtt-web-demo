<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MQTT Auto Publisher + Chart</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chart-container { width: 90%; max-width: 800px; margin: auto; }
  </style>
</head>
<body>
  <h2>MQTT Auto Publisher (HiveMQ Cloud)</h2>
  <p id="status">Tr·∫°ng th√°i: ƒêang k·∫øt n·ªëi...</p>
  <p>Gi√° tr·ªã hi·ªán t·∫°i: <span id="value">0</span></p>
  <div id="received"></div>

  <div id="chart-container">
    <canvas id="myChart"></canvas>
  </div>

  <script>
    // ===== C·∫•u h√¨nh k·∫øt n·ªëi HiveMQ Cloud =====
    const options = {
      username: "Son75Son75",
      password: "Son75Son75",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 1000,
      clientId: "webclient_" + Math.random().toString(16).substr(2, 8)
    };

    const client = mqtt.connect(
      "wss://f1e5f5ad51204b15b4b3931fe01978ae.s1.eu.hivemq.cloud:8884/mqtt",
      options
    );

    // ===== T·∫°o chart =====
    const ctx = document.getElementById("myChart").getContext("2d");
    const chartData = {
      labels: [],
      datasets: [{
        label: "Counter",
        data: [],
        borderColor: "blue",
        backgroundColor: "lightblue",
        fill: false,
        tension: 0.1
      }]
    };
    const chart = new Chart(ctx, {
      type: "line",
      data: chartData,
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: "Time (s)" } },
          y: { min: 0, max: 100, title: { display: true, text: "Value" } }
        }
      }
    });

    // ===== MQTT events =====
    client.on("connect", function () {
      document.getElementById("status").innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi HiveMQ Cloud";
      console.log("Connected to HiveMQ Cloud ‚úÖ");

      client.subscribe("factory/line1/cmd", function(err) {
        if (!err) console.log("Subscribed to factory/line1/cmd");
      });

      startAutoPublish();
    });

    client.on("error", function (err) {
      document.getElementById("status").innerText = "‚ùå L·ªói k·∫øt n·ªëi: " + err;
      console.error("MQTT error: ", err);
    });

    client.on("message", function (topic, message) {
      const msg = message.toString();
      const div = document.getElementById("received");
      div.innerHTML = "üì• Nh·∫≠n t·ª´ " + topic + ": " + msg;
      console.log("Message received:", topic, msg);

      // C·∫≠p nh·∫≠t chart realtime
      updateChart(msg);
    });

    // ===== Bi·∫øn ƒë·∫øm v√† g·ª≠i MQTT =====
    let counter = 0;
    function startAutoPublish() {
      setInterval(() => {
        client.publish("factory/line1/cmd", counter.toString());
        document.getElementById("value").innerText = counter;
        console.log("Published:", counter);

        counter++;
        if (counter > 100) counter = 0;
      }, 1000);
    }

    // ===== Update chart realtime =====
    let t = 0;
    function updateChart(val) {
      chart.data.labels.push(t++);
      chart.data.datasets[0].data.push(Number(val));

      if (chart.data.labels.length > 20) { // gi·ªØ 20 ƒëi·ªÉm g·∫ßn nh·∫•t
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }

      chart.update();
    }
  </script>
</body>
</html>
