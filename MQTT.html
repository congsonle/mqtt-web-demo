<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MQTT Auto Publisher</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h2>MQTT Auto Publisher (HiveMQ Cloud)</h2>
  <p id="status">Tr?ng thái: ?ang k?t n?i...</p>
  <p>Giá tr? hi?n t?i: <span id="value">0</span></p>
  <div id="received"></div>

  <script>
    // C?u hình k?t n?i HiveMQ Cloud
    const options = {
      username: "Son75Son75",
      password: "Son75Son75",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 1000
    };

    // K?t n?i WebSocket Secure (port 8884)
    const client = mqtt.connect(
      "wss://f1e5f5ad51204b15b4b3931fe01978ae.s1.eu.hivemq.cloud:8884/mqtt",
      options
    );

    client.on("connect", function () {
      document.getElementById("status").innerText = "? ?ã k?t n?i HiveMQ Cloud";

      // Subscribe ?? xem l?i d? li?u mình publish
      client.subscribe("factory/line1/cmd");

      // B?t ??u g?i d? li?u t? ??ng
      startAutoPublish();
    });

    client.on("error", function (err) {
      document.getElementById("status").innerText = "? L?i k?t n?i: " + err;
    });

    client.on("message", function (topic, message) {
      const div = document.getElementById("received");
      div.innerHTML =
        "?? Nh?n t? " + topic + ": " + message.toString();
    });

    // Bi?n ??m t? ??ng
    let counter = 0;
    function startAutoPublish() {
      setInterval(() => {
        client.publish("factory/line1/cmd", counter.toString());
        document.getElementById("value").innerText = counter;

        counter++;
        if (counter > 100) counter = 0;
      }, 1000); // 1000ms = 1 giây
    }
  </script>
</body>
</html>